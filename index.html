<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPhone„Çø„Çπ„ÇØÁÆ°ÁêÜ</title>
    
    <!-- iPhone/PWAË®≠ÂÆö -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="„Çø„Çπ„ÇØÁÆ°ÁêÜ">
    <!-- „Ç¢„Éó„É™„Ç¢„Ç§„Ç≥„É≥Ôºà„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅÆ„Ç§„É©„Çπ„ÉàÔºâ -->
    <link rel="apple-touch-icon" href="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f4cb.png">
    <link rel="icon" href="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f4cb.png">

    <!-- React & ReactDOM (Stable Production Version) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX to JS) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* iOS Safe Area Support */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        body {
            -webkit-tap-highlight-color: transparent;
            background-color: #f9fafb;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            /* PWAÊôÇ„Å´‰∏äÈÉ®„ÅåÈö†„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´Ë™øÊï¥ */
            padding-top: env(safe-area-inset-top);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- „Ç¢„Ç§„Ç≥„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà (SVGÁõ¥Êõ∏„Åç„Åß„Ç®„É©„ÉºÂõûÈÅø) ---
        // Â§ñÈÉ®„É©„Ç§„Éñ„É©„É™„Çí‰Ωø„Çè„Åö„ÄÅÁõ¥Êé•SVG„ÇíÊèèÁîª„Åó„Åæ„Åô
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Icons = {
            Calendar: (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            CheckSquare: (props) => <IconBase {...props}><path d="m9 11 3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>,
            Target: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
            ChevronLeft: (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>,
            ChevronRight: (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>,
            Plus: (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            Trash2: (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-1 1-1h6c1 0 1 1 1 1v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            CheckCircle: (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></IconBase>,
            Circle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/></IconBase>,
            Menu: (props) => <IconBase {...props}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>,
            X: (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></IconBase>,
            Edit2: (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>,
            FileText: (props) => <IconBase {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></IconBase>,
            ImageIcon: (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>,
            Save: (props) => <IconBase {...props}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></IconBase>,
            Camera: (props) => <IconBase {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>,
            Search: (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>,
            XCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconBase>,
            TrendingUp: (props) => <IconBase {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>,
            List: (props) => <IconBase {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconBase>,
            AlertTriangle: (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>,
            ChevronDown: (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>,
            ChevronUp: (props) => <IconBase {...props}><path d="m18 15-6-6-6 6"/></IconBase>,
            Eye: (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Folder: (props) => <IconBase {...props}><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></IconBase>,
            FolderPlus: (props) => <IconBase {...props}><path d="M12 10v6"/><path d="M9 13h6"/><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></IconBase>,
            ArrowLeft: (props) => <IconBase {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>,
            MoreHorizontal: (props) => <IconBase {...props}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></IconBase>,
            PenLine: (props) => <IconBase {...props}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>,
        };

        const { 
            Calendar, CheckSquare, Target, ChevronLeft, ChevronRight, 
            Plus, Trash2, CheckCircle, Circle, Menu, X, Edit2, 
            FileText, ImageIcon, Save, Camera, Search, XCircle,
            TrendingUp, List, AlertTriangle, ChevronDown, ChevronUp, Eye, Folder, FolderPlus, ArrowLeft, MoreHorizontal, PenLine
        } = Icons;
        // ---------------------------------------------------

        // --- Helpers ---

        // Ë•øÊö¶„ÇíÂíåÊö¶„Å´Â§âÊèõ„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        const toJapaneseEra = (year) => {
            if (year >= 2019) return `‰ª§Âíå${year - 2018}Âπ¥`;
            if (year >= 1989) return `Âπ≥Êàê${year - 1988}Âπ¥`;
            if (year >= 1926) return `Êò≠Âíå${year - 1925}Âπ¥`;
            return `${year}Âπ¥`;
        };

        // Êó•ÊôÇ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞
        const formatDate = (timestamp) => {
            if (!timestamp) return "";
            const d = new Date(timestamp);
            if (isNaN(d.getTime())) return ""; // Invalid Date check
            
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hour = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${year}/${month}/${day} ${hour}:${min}`;
        };

        // --- Sub-Components ---

        // „Éï„Ç©„É´„ÉÄ‰ΩúÊàê„ÉªÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´
        const FolderModal = ({ isOpen, onClose, onSave, title, initialValue = "" }) => {
            if (!isOpen) return null;
            const [name, setName] = useState(initialValue);
            
            useEffect(() => {
                setName(initialValue);
            }, [initialValue, isOpen]);

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative z-10 shadow-xl animate-fadeIn">
                    <h3 className="text-lg font-bold mb-4 text-gray-800">{title}</h3>
                    <input
                    autoFocus
                    type="text"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none mb-4"
                    placeholder="„Éï„Ç©„É´„ÉÄÂêç„ÇíÂÖ•Âäõ"
                    />
                    <div className="flex gap-3">
                    <button 
                        onClick={onClose}
                        className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:bg-gray-200 transition-colors"
                    >
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                    <button 
                        onClick={() => onSave(name)}
                        disabled={!name.trim()}
                        className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all disabled:opacity-50 disabled:active:scale-100"
                    >
                        ‰øùÂ≠ò
                    </button>
                    </div>
                </div>
                </div>
            );
        };

        // ÊúàÈñì„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´
        const MonthPreviewModal = ({ isOpen, onClose, monthLabel, data, monthKey, onToggle, onDelete, onEdit }) => {
            if (!isOpen) return null;
            
            const reflections = data.reflections || [];
            const goals = data.goals || [];
            const tasks = data.tasks || [];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="bg-white rounded-2xl w-full max-w-md max-h-[85vh] flex flex-col relative z-10 shadow-2xl animate-fadeIn">
                    
                    {/* Header */}
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                    <h3 className="text-xl font-bold text-gray-800">{monthLabel}„ÅÆÂÜÖÂÆπ</h3>
                    <button onClick={onClose} className="p-2 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">
                        <X size={20} />
                    </button>
                    </div>

                    {/* Scrollable Content */}
                    <div className="p-4 overflow-y-auto custom-scrollbar">
                    
                    {/* Reflections */}
                    <div className="mb-6">
                        <h4 className="flex items-center gap-2 font-bold text-gray-700 mb-2 border-b pb-1">
                            <TrendingUp size={18} className="text-blue-500" />
                            ÁèæÁä∂„ÉªÊîπÂñÑ
                        </h4>
                        {reflections.length > 0 ? (
                        reflections.map(item => (
                            <ListItem key={item.id} item={item} type="month_reflection" contextId={monthKey} onToggle={onToggle} onDelete={onDelete} onEdit={onEdit} hideCheckbox />
                        ))
                        ) : (
                        <div className="text-sm text-gray-400 italic py-2 pl-1">Ë®òÈå≤„Å™„Åó</div>
                        )}
                    </div>

                    {/* Goals */}
                    <div className="mb-6">
                        <h4 className="flex items-center gap-2 font-bold text-gray-700 mb-2 border-b pb-1">
                            <Target size={18} className="text-orange-500" />
                            ‰ªäÊúà„ÅÆÁõÆÊ®ô
                        </h4>
                        {goals.length > 0 ? (
                        goals.map(item => (
                            <ListItem key={item.id} item={item} type="month_goal" contextId={monthKey} onToggle={onToggle} onDelete={onDelete} onEdit={onEdit} />
                        ))
                        ) : (
                        <div className="text-sm text-gray-400 italic py-2 pl-1">ÁõÆÊ®ô„Å™„Åó</div>
                        )}
                    </div>

                    {/* Tasks */}
                    <div>
                        <h4 className="flex items-center gap-2 font-bold text-gray-700 mb-2 border-b pb-1">
                            <CheckSquare size={18} className="text-green-500" />
                            „Çø„Çπ„ÇØ
                        </h4>
                        {tasks.length > 0 ? (
                        tasks.map(item => (
                            <ListItem key={item.id} item={item} type="task" contextId={monthKey} onToggle={onToggle} onDelete={onDelete} onEdit={onEdit} />
                        ))
                        ) : (
                        <div className="text-sm text-gray-400 italic py-2 pl-1">„Çø„Çπ„ÇØ„Å™„Åó</div>
                        )}
                    </div>

                    </div>
                </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="bg-white rounded-2xl w-full max-w-xs p-6 relative z-10 shadow-xl animate-fadeIn text-center">
                    <div className="mx-auto w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-4">
                    <AlertTriangle size={24} />
                    </div>
                    <h3 className="text-lg font-bold mb-2 text-gray-800">ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</h3>
                    <p className="text-sm text-gray-500 mb-6 leading-relaxed whitespace-pre-wrap">
                    {message || "„Åì„ÅÆÈ†ÖÁõÆ„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ"}
                    </p>
                    <div className="flex gap-3">
                    <button 
                        onClick={onClose}
                        className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl active:bg-gray-200 transition-colors"
                    >
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                    <button 
                        onClick={onConfirm}
                        className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg active:bg-red-600 active:scale-95 transition-all"
                    >
                        ÂâäÈô§„Åô„Çã
                    </button>
                    </div>
                </div>
                </div>
            );
        };

        const AddModal = ({ 
            isOpen, onClose, onAdd, title, 
            mainLabel = "ÂÜÖÂÆπ", subLabel = "„É°„É¢ (‰ªªÊÑè)", 
            placeholderMain = "ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...", placeholderSub = "Ë©≥Á¥∞„Åå„ÅÇ„Çå„Å∞ÂÖ•Âäõ...",
            allowImage = false,
            folders = [], 
            currentFolderId = null 
        }) => {
            if (!isOpen) return null;

            const [text, setText] = useState("");
            const [memo, setMemo] = useState("");
            const [image, setImage] = useState(null); 
            const [selectedFolderId, setSelectedFolderId] = useState(currentFolderId || ""); 
            const fileInputRef = useRef(null);

            useEffect(() => {
                setSelectedFolderId(currentFolderId || "");
            }, [currentFolderId, isOpen]);

            const handleSubmit = () => {
                if (!text.trim() && !image) return; 
                onAdd(text, memo, image, selectedFolderId); 
                setText("");
                setMemo("");
                setImage(null);
                onClose();
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    setImage(reader.result);
                };
                reader.readAsDataURL(file);
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative z-10 shadow-xl animate-fadeIn">
                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                    <Plus size={24} className="text-blue-500" />
                    {title}
                    </h3>
                    
                    <div className="space-y-4">
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">{mainLabel}</label>
                        <input
                        autoFocus
                        type="text"
                        value={text}
                        onChange={(e) => setText(e.target.value)}
                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder={placeholderMain}
                        />
                    </div>
                    
                    {allowImage && (
                        <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">„Éï„Ç©„É´„ÉÄ</label>
                        <select
                            value={selectedFolderId}
                            onChange={(e) => setSelectedFolderId(e.target.value)}
                            className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none appearance-none"
                        >
                            <option value="">„Åô„Åπ„Å¶„ÅÆ„É°„É¢ (Êú™ÂàÜÈ°û)</option>
                            {folders.map(f => (
                            <option key={f.id} value={f.id}>{f.name}</option>
                            ))}
                        </select>
                        </div>
                    )}

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">{subLabel}</label>
                        <textarea
                        value={memo}
                        onChange={(e) => setMemo(e.target.value)}
                        placeholder={placeholderSub}
                        className="w-full p-3 h-24 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                        />
                    </div>

                    {allowImage && (
                        <div>
                        <input 
                            type="file" 
                            accept="image/*" 
                            ref={fileInputRef} 
                            onChange={handleFileChange} 
                            className="hidden" 
                        />
                        
                        {!image ? (
                            <button 
                            onClick={() => fileInputRef.current.click()}
                            className="flex items-center gap-2 text-sm text-blue-600 font-bold p-2 hover:bg-blue-50 rounded-lg transition-colors"
                            >
                            <Camera size={18} />
                            ÂÜôÁúü„ÇíËøΩÂä†
                            </button>
                        ) : (
                            <div className="relative mt-2 rounded-lg overflow-hidden border border-gray-200 group">
                            <img src={image} alt="Preview" className="w-full h-32 object-cover" />
                            <button 
                                onClick={() => setImage(null)}
                                className="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full hover:bg-black/70"
                            >
                                <X size={16} />
                            </button>
                            </div>
                        )}
                        </div>
                    )}

                    <button 
                        onClick={handleSubmit}
                        className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform"
                    >
                        ‰øùÂ≠ò„Åô„Çã
                    </button>
                    </div>
                </div>
                </div>
            );
        };

        const SelectionMenu = ({ isOpen, onClose, options, title }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="bg-white rounded-2xl w-full max-w-sm p-4 relative z-10 animate-fadeIn space-y-3 mb-6 sm:mb-0">
                    <div className="text-center font-bold text-gray-500 text-sm mb-2">{title}</div>
                    {options.map((opt, idx) => (
                        <button key={idx} onClick={opt.onClick} className={`w-full p-4 ${opt.bgColor || 'bg-gray-50'} hover:opacity-80 rounded-xl flex items-center gap-4 font-bold text-gray-700 transition-colors`}>
                        <div className={`p-2 ${opt.iconColor || 'bg-gray-500'} rounded-full text-white`}>{opt.icon}</div>
                        <span>{opt.label}</span>
                        </button>
                    ))}
                    <button onClick={onClose} className="w-full p-3 mt-2 text-gray-500 font-medium">
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                </div>
                </div>
            );
        };

        const FloatingActionButton = ({ onClick, visible }) => {
            if (!visible) return null;
            return (
                <button
                onClick={onClick}
                className="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 active:scale-90 transition-all z-40 animate-fadeIn"
                >
                <Plus size={28} />
                </button>
            );
        };

        const ListItem = ({ item, type, onToggle, onDelete, onEdit, hideCheckbox = false, contextId }) => (
            <div className="group bg-white p-3 rounded-xl shadow-sm border border-gray-100 mb-2 transition-all hover:shadow-md">
                <div className="flex items-start gap-3">
                {!hideCheckbox && (
                    <button 
                    onClick={() => onToggle(type, item.id, contextId)}
                    className={`mt-0.5 flex-shrink-0 ${item.completed ? 'text-green-500' : 'text-gray-300'}`}
                    >
                    {item.completed ? <CheckCircle size={22} className="fill-green-50" /> : <Circle size={22} />}
                    </button>
                )}
                
                <div 
                    className="flex-grow cursor-pointer"
                    onClick={() => onEdit(item, type, contextId)}
                >
                    <div className={`text-sm font-medium ${item.completed ? 'text-gray-400 line-through' : 'text-gray-800'}`}>
                    {item.text}
                    </div>
                    {item.memo && (
                    <div className="text-xs text-gray-500 mt-1 line-clamp-2">
                        <span className="font-bold mr-1">Memo:</span>{item.memo}
                    </div>
                    )}
                    {/* Êó•ÊôÇË°®Á§∫ */}
                    <div className="text-[10px] text-gray-400 mt-1">
                        {formatDate(item.id)}
                    </div>
                </div>

                <button onClick={() => onDelete(type, item.id, contextId)} className="text-gray-300 hover:text-red-500 p-1">
                    <Trash2 size={16} />
                </button>
                </div>
            </div>
        );

        const SideMenu = ({ isOpen, onClose, activeView, setActiveView }) => (
            <>
                <div 
                className={`fixed inset-0 bg-black/50 z-40 transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
                onClick={onClose}
                />
                <div className={`fixed top-0 left-0 h-full w-64 bg-white shadow-2xl z-50 transform transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                <div className="p-5 border-b flex justify-between items-center bg-gray-50">
                    <h2 className="font-bold text-lg text-gray-800">Menu</h2>
                    <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-200">
                    <X size={20} />
                    </button>
                </div>
                <nav className="p-4 space-y-2">
                    {[
                    { id: 'year', label: 'Âπ¥ÈñìÁõÆÊ®ô (Âπ¥Â∫¶)', icon: Target },
                    { id: 'month', label: 'ÊúàÈñìÁõÆÊ®ô„ÉªÊåØ„ÇäËøî„Çä', icon: Calendar },
                    { id: 'tasks', label: '‰ªäÊúà„ÅÆ„Çø„Çπ„ÇØ', icon: CheckSquare },
                    { id: 'notebook', label: '„É°„É¢Â∏≥', icon: FileText },
                    ].map(item => (
                    <button
                        key={item.id}
                        onClick={() => {
                        setActiveView(item.id);
                        onClose();
                        }}
                        className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-colors ${activeView === item.id ? 'bg-blue-50 text-blue-600 font-bold' : 'text-gray-600 hover:bg-gray-50'}`}
                    >
                        <item.icon size={20} />
                        <span>{item.label}</span>
                    </button>
                    ))}
                </nav>
                </div>
            </>
        );

        const EditModal = ({ isOpen, item, onClose, onSave, folders = [] }) => {
            if (!isOpen || !item) return null;

            const [tempText, setTempText] = useState(item.text || item.title); 
            const [tempMemo, setTempMemo] = useState(item.memo || item.content || "");
            const [tempImage, setTempImage] = useState(item.image || null); 
            const [tempFolderId, setTempFolderId] = useState(item.folderId || "");
            const fileInputRef = useRef(null);

            useEffect(() => {
                setTempText(item.text || item.title || "");
                setTempMemo(item.memo || item.content || "");
                setTempImage(item.image || null);
                setTempFolderId(item.folderId || "");
            }, [item]);

            const handleSave = () => {
                onSave({
                ...item,
                text: tempText,   
                title: tempText,  
                memo: tempMemo,   
                content: tempMemo,
                image: tempImage,
                folderId: tempFolderId 
                });
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                const reader = new FileReader();
                reader.onloadend = () => setTempImage(reader.result);
                reader.readAsDataURL(file);
                }
            };

            const isNotebook = item.contextType === 'notebook' || item.type === 'note';

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative z-10 shadow-xl animate-fadeIn">
                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                    <Edit2 size={18} className="text-blue-500" />
                    Ë©≥Á¥∞„ÉªÁ∑®ÈõÜ
                    </h3>
                    
                    <div className="space-y-4">
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">„Çø„Ç§„Éà„É´</label>
                        <input
                        type="text"
                        value={tempText}
                        onChange={(e) => setTempText(e.target.value)}
                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ"
                        />
                    </div>
                    
                    {isNotebook && (
                        <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">„Éï„Ç©„É´„ÉÄ</label>
                        <select
                            value={tempFolderId}
                            onChange={(e) => setTempFolderId(e.target.value)}
                            className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none appearance-none"
                        >
                            <option value="">„Åô„Åπ„Å¶„ÅÆ„É°„É¢ (Êú™ÂàÜÈ°û)</option>
                            {folders.map(f => (
                            <option key={f.id} value={f.id}>{f.name}</option>
                            ))}
                        </select>
                        </div>
                    )}

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">„É°„É¢</label>
                        <textarea
                        value={tempMemo}
                        onChange={(e) => setTempMemo(e.target.value)}
                        placeholder="Ë©≥Á¥∞„ÇÑÂÇôËÄÉ„ÇíÂÖ•Âäõ..."
                        className="w-full p-3 h-32 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                        />
                    </div>

                    {isNotebook && (
                        <div>
                        <input 
                            type="file" 
                            accept="image/*" 
                            ref={fileInputRef} 
                            onChange={handleFileChange} 
                            className="hidden" 
                        />
                        {!tempImage ? (
                            <button 
                            onClick={() => fileInputRef.current.click()}
                            className="flex items-center gap-2 text-sm text-blue-600 font-bold p-2 hover:bg-blue-50 rounded-lg transition-colors"
                            >
                            <Camera size={18} />
                            ÂÜôÁúü„ÇíËøΩÂä†
                            </button>
                        ) : (
                            <div className="relative mt-2 rounded-lg overflow-hidden border border-gray-200">
                            <img src={tempImage} alt="Attachment" className="w-full h-32 object-cover" />
                            <button 
                                onClick={() => setTempImage(null)}
                                className="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full"
                            >
                                <X size={16} />
                            </button>
                            </div>
                        )}
                        </div>
                    )}

                    <button 
                        onClick={handleSave}
                        className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform"
                    >
                        <Save size={18} />
                        ‰øùÂ≠ò„Åô„Çã
                    </button>
                    </div>
                </div>
                </div>
            );
        };

        const Header = ({ onOpenMenu, title, subTitle, onPrev, onNext, showNav = true, leftButton }) => (
            <div className="bg-white border-b sticky top-0 z-30 safe-top pt-2 pb-2 px-4 shadow-sm flex items-center justify-between h-14">
                <div className="flex items-center">
                    {leftButton ? leftButton : (
                        <button onClick={onOpenMenu} className="p-2 -ml-2 text-gray-700 hover:bg-gray-100 rounded-full">
                        <Menu size={24} />
                        </button>
                    )}
                </div>
                
                {showNav && (
                <div className="flex items-center gap-4">
                    <button onClick={onPrev} className="p-1 text-gray-400 hover:text-blue-600">
                    <ChevronLeft size={24} />
                    </button>
                    <div className="text-center">
                    {subTitle && <div className="text-[10px] text-gray-500 font-bold leading-tight">{subTitle}</div>}
                    <div className="text-lg font-bold text-gray-800 leading-tight">{title}</div>
                    </div>
                    <button onClick={onNext} className="p-1 text-gray-400 hover:text-blue-600">
                    <ChevronRight size={24} />
                    </button>
                </div>
                )}
                {!showNav && (
                <div className="text-lg font-bold text-gray-800">{title}</div>
                )}

                <div className="w-8"></div>
            </div>
        );

        // --- View Components ---

        const YearView = ({ 
            goals, fiscalYear, monthlyData,
            onToggle, onDelete, onEdit, onDeleteFiscalYear
        }) => {
            const [previewMonth, setPreviewMonth] = useState(null);

            // Generate 12 months for the fiscal year (April to March)
            const months = [];
            for (let i = 0; i < 12; i++) {
                const d = new Date(fiscalYear, 3 + i, 1); // Start from April
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                months.push({
                date: d,
                key: key,
                label: `${d.getMonth() + 1}Êúà`,
                data: monthlyData[key] || { goals: [], reflections: [], tasks: [] }
                });
            }

            return (
                <div className="p-4 pb-24 animate-fadeIn">
                {/* Annual Goals Card */}
                <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-lg text-white mb-6 relative overflow-hidden group">
                    <div className="relative z-10 flex justify-between items-start">
                    <div>
                        <div className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1">Fiscal Year</div>
                        <h2 className="text-3xl font-bold mb-1">{toJapaneseEra(fiscalYear).replace('Âπ¥', 'Âπ¥Â∫¶')}</h2>
                        <p className="text-indigo-100 text-sm opacity-90">4Êúà1Êó• „Äú ÁøåÂπ¥3Êúà31Êó•</p>
                    </div>
                    <button 
                        onClick={(e) => { e.stopPropagation(); onDeleteFiscalYear(fiscalYear); }}
                        className="p-2 bg-white/10 hover:bg-white/20 rounded-lg text-white transition-colors"
                        title="„Åì„ÅÆÂπ¥Â∫¶„ÅÆ„Éá„Éº„Çø„Çí„Åô„Åπ„Å¶ÂâäÈô§"
                    >
                        <Trash2 size={20} />
                    </button>
                    </div>
                    <Target className="absolute right-[-20px] bottom-[-20px] text-white opacity-10 w-32 h-32" />
                </div>

                {/* Annual Goals List */}
                <div className="mb-8">
                    <h3 className="text-gray-600 font-bold mb-3 px-1 flex items-center justify-between">
                    <span>Âπ¥ÈñìÁõÆÊ®ô</span>
                    <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">{goals.length}‰ª∂</span>
                    </h3>
                    {goals.map(item => (
                    <ListItem 
                        key={item.id} 
                        item={item} 
                        type="year" 
                        onToggle={onToggle}
                        onDelete={onDelete}
                        onEdit={onEdit}
                    />
                    ))}
                    {goals.length === 0 && (
                    <div className="text-center text-gray-400 py-6 bg-white rounded-2xl border border-dashed border-gray-200 text-sm">
                        Âπ¥ÈñìÁõÆÊ®ô„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Çá„ÅÜ
                    </div>
                    )}
                </div>

                {/* Monthly Breakdown (Click to Preview) */}
                <div>
                    <h3 className="text-gray-600 font-bold mb-3 px-1">ÊúàÂà•Ë©≥Á¥∞</h3>
                    <div className="space-y-3">
                    {months.map(month => {
                        const goalCount = (month.data.goals?.length || 0) + (month.data.reflections?.length || 0);
                        const activeTasks = month.data.tasks?.filter(t => !t.completed).length || 0;

                        return (
                        <div key={month.key} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden active:scale-[0.98] transition-transform">
                            <button 
                            onClick={() => setPreviewMonth(month)}
                            className="w-full flex items-center justify-between p-4 bg-gray-50/50 hover:bg-gray-100/80 transition-colors"
                            >
                            <div className="flex items-center gap-3">
                                <div className="font-bold text-gray-800 text-lg">{month.label}</div>
                                <div className="text-xs text-gray-400 flex gap-2">
                                <span className="bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded">ÁõÆÊ®ô: {goalCount}</span>
                                <span className="bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">ÊÆã„Çø„Çπ„ÇØ: {activeTasks}</span>
                                </div>
                            </div>
                            <Eye size={20} className="text-gray-400" />
                            </button>
                        </div>
                        );
                    })}
                    </div>
                </div>

                <MonthPreviewModal 
                    isOpen={!!previewMonth}
                    onClose={() => setPreviewMonth(null)}
                    monthLabel={previewMonth?.label}
                    monthKey={previewMonth?.key}
                    data={previewMonth?.data || {}}
                    onToggle={onToggle}
                    onDelete={onDelete}
                    onEdit={onEdit}
                />
                </div>
            );
        };

        const MonthView = ({ data, onToggle, onDelete, onEdit }) => {
            const reflections = data.reflections || [];

            return (
                <div className="p-4 pb-24 animate-fadeIn space-y-6">
                
                {/* Reflections Section */}
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h3 className="font-bold text-gray-800 flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                        <TrendingUp size={18} className="text-blue-500" />
                        <span>ÁèæÁä∂„ÉªÊîπÂñÑ</span>
                    </div>
                    <span className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full">{reflections.length}‰ª∂</span>
                    </h3>
                    
                    <div className="space-y-1">
                    {reflections.map(item => (
                        <ListItem 
                            key={item.id} 
                            item={item} 
                            type="month_reflection" 
                            onToggle={onToggle}
                            onDelete={onDelete}
                            onEdit={onEdit}
                            hideCheckbox={true} 
                        />
                    ))}
                    {reflections.length === 0 && (
                        <div className="text-sm text-gray-400 text-center py-4 border border-dashed border-gray-200 rounded-xl">
                            + „Éú„Çø„É≥„Åã„ÇâÁèæÁä∂„ÇÑÊîπÂñÑÁÇπ„ÇíËøΩÂä†
                        </div>
                    )}
                    </div>
                </div>

                {/* Goals Section */}
                <div>
                    <h3 className="font-bold text-gray-700 mb-3 px-1 flex items-center justify-between">
                    <span>‰ªäÊúà„ÅÆÁõÆÊ®ô</span>
                    <span className="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full">{data.goals?.length || 0}‰ª∂</span>
                    </h3>
                    {data.goals?.map(item => (
                    <ListItem 
                        key={item.id} 
                        item={item} 
                        type="month_goal" 
                        onToggle={onToggle}
                        onDelete={onDelete}
                        onEdit={onEdit}
                    />
                    ))}
                    {(!data.goals || data.goals.length === 0) && (
                    <div className="text-center text-gray-400 py-8 bg-white rounded-xl border border-dashed border-gray-200 text-sm">
                        ‰ªäÊúà„ÅÆÁõÆÊ®ô„ÇíËøΩÂä†„Åó„Åæ„Åó„Çá„ÅÜ
                    </div>
                    )}
                </div>
                </div>
            );
        };

        const TasksView = ({ tasks, onToggle, onDelete, onEdit, showCompleted, onToggleShowCompleted }) => {
            const activeTasks = tasks.filter(t => !t.completed);
            const completedTasks = tasks.filter(t => t.completed);
            const completionRate = tasks.length > 0 ? Math.round((completedTasks.length / tasks.length) * 100) : 0;

            return (
                <div className="p-4 pb-24 animate-fadeIn">
                <div className="grid grid-cols-2 gap-3 mb-6">
                    <div className="bg-blue-50 p-4 rounded-2xl">
                    <div className="text-xs text-blue-500 font-bold mb-1">ÊÆã„Çä„Çø„Çπ„ÇØ</div>
                    <div className="text-2xl font-bold text-blue-900">{activeTasks.length}</div>
                    </div>
                    <div className="bg-green-50 p-4 rounded-2xl">
                    <div className="text-xs text-green-600 font-bold mb-1">ÈÅîÊàêÁéá</div>
                    <div className="text-2xl font-bold text-green-900">{completionRate}%</div>
                    </div>
                </div>

                <div className="mb-8">
                    <h3 className="text-sm font-bold text-gray-500 mb-3 px-1">Êú™ÂÆå‰∫Ü</h3>
                    {activeTasks.length > 0 ? (
                    activeTasks.map(item => (
                        <ListItem 
                        key={item.id} 
                        item={item} 
                        type="task" 
                        onToggle={onToggle}
                        onDelete={onDelete}
                        onEdit={onEdit}
                        />
                    ))
                    ) : (
                    <div className="text-center py-8 bg-white rounded-xl border border-dashed border-gray-200 text-gray-400 text-sm">
                        „Çø„Çπ„ÇØ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì üéâ
                    </div>
                    )}
                </div>

                <div>
                    <button 
                    onClick={onToggleShowCompleted}
                    className="flex items-center gap-2 text-sm font-bold text-gray-500 mb-3 px-1 w-full hover:text-gray-700"
                    >
                    <span>ÂÆå‰∫ÜÊ∏à„Åø ({completedTasks.length})</span>
                    <ChevronRight size={16} className={`transform transition-transform ${showCompleted ? 'rotate-90' : ''}`} />
                    </button>
                    
                    {showCompleted && (
                    <div className="opacity-60">
                        {completedTasks.map(item => (
                        <ListItem 
                            key={item.id} 
                            item={item} 
                            type="task" 
                            onToggle={onToggle}
                            onDelete={onDelete}
                            onEdit={onEdit}
                        />
                        ))}
                    </div>
                    )}
                </div>
                </div>
            );
        };

        const NotebookView = ({ entries, folders, onDelete, onEdit, onFolderCreate, onFolderDelete, onFolderRename, setCurrentFolder, currentFolder }) => {
            const [searchQuery, setSearchQuery] = useState("");
            const [isEditingFolders, setIsEditingFolders] = useState(false);
            
            // -- Folder List View (Root) --
            if (!currentFolder) {
                return (
                <div className="p-4 pb-24 animate-fadeIn relative min-h-[calc(100vh-120px)]">
                    <div className="flex items-center justify-between mb-6">
                    <h2 className="text-2xl font-bold text-gray-800">„Éï„Ç©„É´„ÉÄ</h2>
                    <button 
                        onClick={() => setIsEditingFolders(!isEditingFolders)} 
                        className={`text-sm font-bold px-3 py-1.5 rounded-lg transition-colors ${isEditingFolders ? 'bg-blue-600 text-white' : 'text-blue-600 hover:bg-blue-50'}`}
                    >
                        {isEditingFolders ? "ÂÆå‰∫Ü" : "Á∑®ÈõÜ"}
                    </button>
                    </div>

                    <div className="space-y-3">
                    {/* Default "All Notes" Folder */}
                    <div 
                        onClick={() => !isEditingFolders && setCurrentFolder({ id: 'ALL', name: '„Åô„Åπ„Å¶„ÅÆ„É°„É¢' })}
                        className={`bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between transition-all ${isEditingFolders ? 'opacity-60' : 'active:scale-[0.98] cursor-pointer'}`}
                    >
                        <div className="flex items-center gap-3">
                        <div className="bg-gray-100 p-2 rounded-lg text-gray-600">
                            <Folder size={20} />
                        </div>
                        <span className="font-bold text-gray-700">„Åô„Åπ„Å¶„ÅÆ„É°„É¢</span>
                        </div>
                        <div className="flex items-center gap-2 text-gray-400">
                        <span className="text-sm">{entries.length}</span>
                        {!isEditingFolders && <ChevronRight size={18} />}
                        </div>
                    </div>

                    {/* Uncategorized Folder */}
                    <div 
                        onClick={() => !isEditingFolders && setCurrentFolder({ id: 'UNCATEGORIZED', name: 'Êú™ÂàÜÈ°û' })}
                        className={`bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between transition-all ${isEditingFolders ? 'opacity-60' : 'active:scale-[0.98] cursor-pointer'}`}
                    >
                        <div className="flex items-center gap-3">
                        <div className="bg-gray-100 p-2 rounded-lg text-gray-600">
                            <Folder size={20} />
                        </div>
                        <span className="font-bold text-gray-700">Êú™ÂàÜÈ°û</span>
                        </div>
                        <div className="flex items-center gap-2 text-gray-400">
                        <span className="text-sm">{entries.filter(e => !e.folderId).length}</span>
                        {!isEditingFolders && <ChevronRight size={18} />}
                        </div>
                    </div>

                    {/* User Folders */}
                    {folders.map(folder => {
                        const count = entries.filter(e => e.folderId === folder.id).length;
                        return (
                        <div 
                            key={folder.id}
                            onClick={() => !isEditingFolders && setCurrentFolder(folder)}
                            className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer group"
                        >
                            <div className="flex items-center gap-3 flex-grow">
                            {isEditingFolders ? (
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onFolderDelete(folder.id); }}
                                    className="bg-red-50 text-red-500 p-2 rounded-full mr-1 hover:bg-red-100"
                                >
                                    <Trash2 size={18} />
                                </button>
                            ) : (
                                <div className="bg-blue-50 p-2 rounded-lg text-blue-500">
                                    <Folder size={20} />
                                </div>
                            )}
                            
                            <span className="font-bold text-gray-700 flex-grow truncate">{folder.name}</span>
                            </div>

                            <div className="flex items-center gap-2 text-gray-400">
                            {isEditingFolders ? (
                                <button 
                                    onClick={(e) => { 
                                        e.stopPropagation(); 
                                        onFolderRename(folder.id, folder.name); // Open Modal
                                    }}
                                    className="bg-gray-100 text-gray-600 p-2 rounded-full hover:bg-gray-200"
                                >
                                    <PenLine size={18} />
                                </button>
                            ) : (
                                <>
                                    <span className="text-sm">{count}</span>
                                    <ChevronRight size={18} />
                                </>
                            )}
                            </div>
                        </div>
                        );
                    })}
                    </div>

                    {/* Add Folder Button (Only visible in editing mode, per request "inside edit") */}
                    {isEditingFolders && (
                        <div className="fixed bottom-24 right-6 z-20 animate-fadeIn">
                        <button 
                            onClick={onFolderCreate}
                            className="bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2 hover:bg-blue-700 active:scale-95 transition-transform"
                        >
                            <FolderPlus size={20} />
                            Êñ∞Ë¶è„Éï„Ç©„É´„ÉÄ
                        </button>
                        </div>
                    )}
                </div>
                );
            }

            // -- Note List View (Inside Folder) --
            const filteredEntries = entries.filter(entry => {
                const q = searchQuery.toLowerCase();
                const titleMatch = (entry.title || "").toLowerCase().includes(q);
                const contentMatch = (entry.content || "").toLowerCase().includes(q);
                
                // Filter by Folder
                let folderMatch = true;
                if (currentFolder.id === 'ALL') folderMatch = true;
                else if (currentFolder.id === 'UNCATEGORIZED') folderMatch = !entry.folderId;
                else folderMatch = entry.folderId === currentFolder.id;

                return (titleMatch || contentMatch) && folderMatch;
            });

            return (
                <div className="p-4 pb-24 animate-fadeIn">
                {/* Header with Back Button */}
                <div className="flex items-center gap-2 mb-4">
                    <button onClick={() => setCurrentFolder(null)} className="flex items-center text-blue-600 font-bold text-sm">
                    <ChevronLeft size={20} />
                    „Éï„Ç©„É´„ÉÄ
                    </button>
                </div>
                
                <div className="flex items-center justify-between mb-4">
                    <h2 className="text-2xl font-bold text-gray-800">{currentFolder.name}</h2>
                </div>

                <div className="bg-white p-2 rounded-xl border border-gray-200 flex items-center gap-2 mb-6 focus-within:ring-2 focus-within:ring-blue-500">
                    <Search size={20} className="text-gray-400 ml-1" />
                    <input 
                    type="text" 
                    placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢..." 
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="flex-grow bg-transparent outline-none text-sm p-1"
                    />
                    {searchQuery && (
                    <button onClick={() => setSearchQuery("")} className="text-gray-400 hover:text-gray-600 p-1">
                        <XCircle size={16} className="fill-gray-200" />
                    </button>
                    )}
                </div>

                <div className="grid gap-4">
                    {filteredEntries.map(entry => (
                    <div key={entry.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative group transition-all hover:shadow-md cursor-pointer" onClick={() => onEdit(entry, 'notebook')}>
                        <button 
                            onClick={(e) => { e.stopPropagation(); onDelete('notebook', entry.id); }}
                            className="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity z-10"
                        >
                            <Trash2 size={16} />
                        </button>

                        <div className="flex items-center gap-2 mb-2">
                        <FileText size={16} className="text-blue-500" />
                        <span className="text-xs text-gray-400">{new Date(entry.date).toLocaleDateString()}</span>
                        </div>

                        <h3 className="font-bold text-gray-800 mb-2">{entry.title}</h3>

                        {entry.content && <p className="text-sm text-gray-600 whitespace-pre-wrap mb-2 line-clamp-3">{entry.content}</p>}
                        
                        {(entry.image || (entry.type === 'image' && entry.content)) && (
                        <div className="rounded-lg overflow-hidden bg-gray-100 border border-gray-200 mt-2">
                            <img src={entry.image || entry.content} alt={entry.title} className="w-full h-40 object-cover" />
                        </div>
                        )}
                    </div>
                    ))}
                    
                    {filteredEntries.length === 0 && (
                    <div className="text-center py-12 text-gray-400 text-sm">
                        „É°„É¢„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                    )}
                </div>
                </div>
            );
        };

        // --- Main App Component ---

        function App() {
            // --- State Management ---
            const [activeView, setActiveView] = useState('tasks');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [currentDate, setCurrentDate] = useState(new Date());
            
            // Modals & Menus
            const [editingItem, setEditingItem] = useState(null); 
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isSelectionMenuOpen, setIsSelectionMenuOpen] = useState(false);
            const [deleteConfig, setDeleteConfig] = useState({ isOpen: false, type: null, id: null, contextId: null });
            const [monthAddTarget, setMonthAddTarget] = useState('goal'); 
            
            // Notebook States
            const [folders, setFolders] = useState(() => {
                try {
                const saved = localStorage.getItem('notebookFolders');
                return saved ? JSON.parse(saved) : [];
                } catch(e) { return []; }
            });
            const [currentNotebookFolder, setCurrentNotebookFolder] = useState(null); 
            
            // Folder Modal State (New!)
            const [folderModalConfig, setFolderModalConfig] = useState({ 
                isOpen: false, 
                mode: 'create', // 'create' or 'rename'
                targetId: null,
                initialValue: ""
            });

            // --- Fiscal Year Helpers ---
            const getFiscalYear = (date) => {
                return date.getMonth() >= 3 ? date.getFullYear() : date.getFullYear() - 1;
            };
            const fiscalYear = getFiscalYear(currentDate);

            // --- Data State ---
            const [yearlyGoals, setYearlyGoals] = useState(() => {
                try {
                const saved = localStorage.getItem('fy_yearlyGoals');
                return saved ? JSON.parse(saved) : {};
                } catch (e) { return {}; }
            });

            const [monthlyData, setMonthlyData] = useState(() => {
                try {
                const saved = localStorage.getItem('monthlyData_v2');
                const parsed = saved ? JSON.parse(saved) : {};
                Object.keys(parsed).forEach(key => {
                    if (!parsed[key].reflections) parsed[key].reflections = [];
                });
                return parsed;
                } catch (e) { return {}; }
            });

            const [notebookEntries, setNotebookEntries] = useState(() => {
                try {
                const saved = localStorage.getItem('notebookEntries');
                return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            const [showCompletedTasks, setShowCompletedTasks] = useState(false);

            // --- Persistence ---
            useEffect(() => { localStorage.setItem('activeView', activeView); }, [activeView]);
            useEffect(() => { localStorage.setItem('fy_yearlyGoals', JSON.stringify(yearlyGoals)); }, [yearlyGoals]);
            useEffect(() => { localStorage.setItem('monthlyData_v2', JSON.stringify(monthlyData)); }, [monthlyData]);
            useEffect(() => { localStorage.setItem('notebookEntries', JSON.stringify(notebookEntries)); }, [notebookEntries]);
            useEffect(() => { localStorage.setItem('notebookFolders', JSON.stringify(folders)); }, [folders]);

            // --- Date Helpers ---
            const getMonthKey = (date) => {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            };

            // ÂâçÊúà„ÅÆ„Ç≠„Éº„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„Éº„ÇíËøΩÂä†
            const getPreviousMonthKey = (date) => {
                const prevDate = new Date(date);
                prevDate.setMonth(prevDate.getMonth() - 1);
                return getMonthKey(prevDate);
            };

            const currentKey = getMonthKey(currentDate);

            const ensureMonthData = () => {
                if (!monthlyData[currentKey]) {
                setMonthlyData(prev => {
                    // ‰∫åÈáç‰ΩúÊàêÈò≤Ê≠¢
                    if (prev[currentKey]) return prev;

                    const prevKey = getPreviousMonthKey(currentDate);
                    let carriedOverTasks = [];

                    // ÂâçÊúà„ÅÆ„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÄÅÊú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÇíË§áË£Ω„Åó„Å¶Âºï„ÅçÁ∂ô„Åê
                    if (prev[prevKey] && prev[prevKey].tasks) {
                        carriedOverTasks = prev[prevKey].tasks
                            .filter(task => !task.completed) // Êú™ÂÆå‰∫Ü„ÅÆ„ÅøÊäΩÂá∫
                            .map((task, index) => ({
                                ...task,
                                id: Date.now() + index, // Êñ∞„Åó„ÅÑÊúà„ÅÆ„Çø„Çπ„ÇØ„Å®„Åó„Å¶Êñ∞„Åó„ÅÑID„Çí‰ªò‰∏é
                            }));
                    }

                    return {
                        ...prev,
                        [currentKey]: { goals: [], reflections: [], tasks: carriedOverTasks }
                    };
                });
                }
            };
            useEffect(() => { ensureMonthData(); }, [currentKey]);

            const changeMonth = (increment) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + increment);
                setCurrentDate(newDate);
            };

            const changeYear = (increment) => {
                const newDate = new Date(currentDate);
                newDate.setFullYear(newDate.getFullYear() + increment);
                setCurrentDate(newDate);
            };

            // --- CRUD Handlers ---
            const handleAddItem = (text, memo, image, folderId) => {
                const newItem = { 
                id: Date.now(), 
                text: text, 
                memo: memo, 
                completed: false 
                };

                if (activeView === 'year') {
                setYearlyGoals(prev => ({
                    ...prev,
                    [fiscalYear]: [...(prev[fiscalYear] || []), newItem]
                }));
                } else if (activeView === 'notebook') {
                const newEntry = {
                    id: Date.now(),
                    type: 'note',
                    title: text || "ÁÑ°È°å",
                    content: memo,
                    image: image,
                    date: new Date().toISOString(),
                    folderId: folderId || null // Save folder ID
                };
                setNotebookEntries([newEntry, ...notebookEntries]);
                } else if (activeView === 'month') {
                    const collection = monthAddTarget === 'reflection' ? 'reflections' : 'goals';
                    setMonthlyData(prev => ({
                        ...prev,
                        [currentKey]: {
                        ...prev[currentKey],
                        [collection]: [...(prev[currentKey]?.[collection] || []), newItem]
                        }
                    }));
                } else {
                setMonthlyData(prev => ({
                    ...prev,
                    [currentKey]: {
                    ...prev[currentKey],
                    tasks: [...(prev[currentKey]?.tasks || []), newItem]
                    }
                }));
                }
            };

            const handleUpdateItem = (updatedItem) => {
                const { contextType, contextId } = editingItem; 
                
                if (contextType === 'year') {
                setYearlyGoals(prev => ({
                    ...prev,
                    [fiscalYear]: prev[fiscalYear].map(item => item.id === updatedItem.id ? updatedItem : item)
                }));
                } else if (contextType === 'notebook') {
                setNotebookEntries(prev => prev.map(item => item.id === updatedItem.id ? updatedItem : item));
                } else {
                // Use explicit contextId (month key) if available (for YearView drills), otherwise currentKey
                const targetKey = contextId || currentKey;
                let collection = 'tasks';
                if (contextType === 'month_goal') collection = 'goals';
                if (contextType === 'month_reflection') collection = 'reflections';

                setMonthlyData(prev => ({
                    ...prev,
                    [targetKey]: {
                    ...prev[targetKey],
                    [collection]: prev[targetKey][collection].map(item => item.id === updatedItem.id ? updatedItem : item)
                    }
                }));
                }
                setIsEditModalOpen(false);
                setEditingItem(null);
            };

            const toggleComplete = (type, id, contextId) => {
                if (type === 'year') {
                setYearlyGoals(prev => ({
                    ...prev,
                    [fiscalYear]: prev[fiscalYear].map(item => 
                    item.id === id ? { ...item, completed: !item.completed } : item
                    )
                }));
                } else {
                    const targetKey = contextId || currentKey;
                    let collection = 'tasks';
                    if (type === 'month_goal') collection = 'goals';
                    if (type === 'month_reflection') collection = 'reflections';

                    // Ensure target data exists before mapping (safe guard for YearView clicks)
                    if (!monthlyData[targetKey]) return;

                    setMonthlyData(prev => ({
                    ...prev,
                    [targetKey]: {
                        ...prev[targetKey],
                        [collection]: prev[targetKey][collection].map(item => 
                        item.id === id ? { ...item, completed: !item.completed } : item
                        )
                    }
                    }));
                }
            };

            const handleDeleteRequest = (type, id, contextId) => {
                setDeleteConfig({ isOpen: true, type, id, contextId });
            };

            const handleDeleteFiscalYearRequest = (year) => {
                setDeleteConfig({ 
                    isOpen: true, 
                    type: 'fiscal_year', 
                    id: year, 
                    contextId: null 
                });
            };

            // Folder CRUD
            
            // Open create modal
            const openCreateFolderModal = () => {
                setFolderModalConfig({ isOpen: true, mode: 'create', targetId: null, initialValue: "" });
            };

            // Open rename modal
            const openRenameFolderModal = (id, currentName) => {
                setFolderModalConfig({ isOpen: true, mode: 'rename', targetId: id, initialValue: currentName });
            };

            // Save logic for folder modal
            const handleFolderModalSave = (name) => {
                if (!name.trim()) return;
                
                if (folderModalConfig.mode === 'create') {
                setFolders([...folders, { id: Date.now().toString(), name: name.trim() }]);
                } else if (folderModalConfig.mode === 'rename' && folderModalConfig.targetId) {
                setFolders(prev => prev.map(f => f.id === folderModalConfig.targetId ? { ...f, name: name.trim() } : f));
                }
                
                setFolderModalConfig({ ...folderModalConfig, isOpen: false });
            };

            const handleDeleteFolderRequest = (folderId) => {
                setDeleteConfig({ 
                isOpen: true, 
                type: 'folder', 
                id: folderId, 
                contextId: null 
                });
            };

            const performDelete = () => {
                const { type, id, contextId } = deleteConfig;
                if (!type || !id) return;

                if (type === 'fiscal_year') {
                    const targetYear = id; 
                    setYearlyGoals(prev => {
                        const next = { ...prev };
                        delete next[targetYear];
                        return next;
                    });
                    setMonthlyData(prev => {
                        const next = { ...prev };
                        Object.keys(next).forEach(key => {
                            const [y, m] = key.split('-').map(Number);
                            const keyFY = m >= 4 ? y : y - 1;
                            if (keyFY === targetYear) delete next[key];
                        });
                        return next;
                    });
                } else if (type === 'folder') {
                    // Delete folder AND its contents
                    setFolders(prev => prev.filter(f => f.id !== id));
                    setNotebookEntries(prev => prev.filter(e => e.folderId !== id));
                } else if (type === 'year') {
                setYearlyGoals(prev => ({
                    ...prev,
                    [fiscalYear]: prev[fiscalYear].filter(item => item.id !== id)
                }));
                } else if (type === 'notebook') {
                setNotebookEntries(prev => prev.filter(item => item.id !== id));
                } else {
                const targetKey = contextId || currentKey;
                let collection = 'tasks';
                if (type === 'month_goal') collection = 'goals';
                if (type === 'month_reflection') collection = 'reflections';

                if (monthlyData[targetKey]) {
                    setMonthlyData(prev => ({
                    ...prev,
                    [targetKey]: {
                        ...prev[targetKey],
                        [collection]: prev[targetKey][collection].filter(item => item.id !== id)
                    }
                    }));
                }
                }
                setDeleteConfig({ isOpen: false, type: null, id: null, contextId: null });
            };

            const openEditModal = (item, type, contextId) => {
                setEditingItem({ ...item, contextType: type, contextId });
                setIsEditModalOpen(true);
            };

            const handleFabClick = () => {
                if (activeView === 'notebook') {
                    setIsAddModalOpen(true);
                } else if (activeView === 'month') {
                    setIsSelectionMenuOpen(true);
                } else {
                    setIsAddModalOpen(true);
                }
            };

            const getMenuOptions = () => {
                if (activeView === 'month') {
                    return [
                        { 
                            label: "‰ªäÊúà„ÅÆÁõÆÊ®ô„ÇíËøΩÂä†", 
                            icon: <Target size={20} />, 
                            bgColor: "bg-orange-50", 
                            iconColor: "bg-orange-500",
                            onClick: () => {
                                setMonthAddTarget('goal');
                                setIsSelectionMenuOpen(false);
                                setIsAddModalOpen(true);
                            }
                        },
                        { 
                            label: "ÁèæÁä∂„ÉªÊîπÂñÑ„ÇíËøΩÂä†", 
                            icon: <TrendingUp size={20} />, 
                            bgColor: "bg-purple-50", 
                            iconColor: "bg-purple-500",
                            onClick: () => {
                                setMonthAddTarget('reflection');
                                setIsSelectionMenuOpen(false);
                                setIsAddModalOpen(true);
                            }
                        }
                    ];
                }
                return [];
            };

            const getAddModalProps = () => {
                switch(activeView) {
                case 'year': 
                    return { title: 'Âπ¥ÈñìÁõÆÊ®ô„ÇíËøΩÂä†', mainLabel: 'ÁõÆÊ®ô', subLabel: 'Ë©≥Á¥∞„É°„É¢ (‰ªªÊÑè)' };
                case 'month': 
                    return monthAddTarget === 'reflection' 
                    ? { title: 'ÁèæÁä∂„ÉªÊîπÂñÑ„ÇíËøΩÂä†', mainLabel: 'ÂÜÖÂÆπ', subLabel: 'Ë©≥Á¥∞„É°„É¢ (‰ªªÊÑè)' }
                    : { title: '‰ªäÊúà„ÅÆÁõÆÊ®ô„ÇíËøΩÂä†', mainLabel: 'ÁõÆÊ®ô', subLabel: 'Ë©≥Á¥∞„É°„É¢ (‰ªªÊÑè)' };
                case 'tasks': 
                    return { title: '„Çø„Çπ„ÇØ„ÇíËøΩÂä†', mainLabel: '„Çø„Çπ„ÇØÂÜÖÂÆπ', subLabel: 'Ë©≥Á¥∞„É°„É¢ (‰ªªÊÑè)' };
                case 'notebook': 
                    return { 
                    title: '„É°„É¢„Çí‰ΩúÊàê', 
                    mainLabel: '„Çø„Ç§„Éà„É´', 
                    subLabel: 'Êú¨Êñá', 
                    placeholderMain: '„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ', 
                    placeholderSub: '„É°„É¢Êú¨Êñá„ÇíÂÖ•Âäõ...',
                    allowImage: true,
                    folders: folders, // Pass folders for selection
                    currentFolderId: currentFolderIdForModal() 
                    };
                default: 
                    return { title: 'ËøΩÂä†' };
                }
            };

            // Helper to determine what folder ID to pre-select in Add Modal
            const currentFolderIdForModal = () => {
                if (activeView !== 'notebook') return null;
                if (currentNotebookFolder && currentNotebookFolder.id !== 'ALL' && currentNotebookFolder.id !== 'UNCATEGORIZED') {
                return currentNotebookFolder.id;
                }
                return ""; // Default (Uncategorized)
            };

            const getHeaderProps = () => {
                if (activeView === 'year') {
                return {
                    title: toJapaneseEra(fiscalYear).replace('Âπ¥', 'Âπ¥Â∫¶'),
                    subTitle: null,
                    onPrev: () => changeYear(-1),
                    onNext: () => changeYear(1),
                };
                } else if (activeView === 'notebook') {
                // Show back button if inside a folder
                if (currentNotebookFolder) {
                    return {
                        title: currentNotebookFolder.name,
                        showNav: false,
                        leftButton: (
                            <button onClick={() => setCurrentNotebookFolder(null)} className="flex items-center text-blue-600 font-bold p-2 -ml-2">
                                <ChevronLeft size={24} />
                                „Éï„Ç©„É´„ÉÄ
                            </button>
                        )
                    }
                }
                return {
                    title: "„Éï„Ç©„É´„ÉÄ",
                    showNav: false
                };
                } else {
                return {
                    title: `${currentDate.getMonth() + 1}Êúà`,
                    subTitle: toJapaneseEra(currentDate.getFullYear()),
                    onPrev: () => changeMonth(-1),
                    onNext: () => changeMonth(1),
                };
                }
            };

            // Helper to determine delete message
            const getDeleteMessage = () => {
                if (deleteConfig.type === 'fiscal_year') {
                    const fyText = toJapaneseEra(deleteConfig.id).replace('Âπ¥', 'Âπ¥Â∫¶');
                    return `${fyText}„ÅÆ„Éá„Éº„Çø„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÄÇ\n\n„ÉªÂπ¥ÈñìÁõÆÊ®ô\n„Éª${fyText}„Å´Âê´„Åæ„Çå„ÇãÂÖ®„Å¶„ÅÆÊúàÈñì„Éá„Éº„Çø\n\n„Åì„Çå„Çâ„ÅØÂÆåÂÖ®„Å´ÂâäÈô§„Åï„Çå„ÄÅÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`;
                }
                if (deleteConfig.type === 'folder') {
                    return "„Éï„Ç©„É´„ÉÄ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ\n\n„Éï„Ç©„É´„ÉÄÂÜÖ„ÅÆ„É°„É¢„ÇÇ„Åô„Åπ„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ";
                }
                return undefined; // Default message
            };

            return (
                <div className="bg-gray-50 min-h-screen font-sans text-gray-900 pb-safe relative">
                
                <SideMenu 
                    isOpen={isMenuOpen} 
                    onClose={() => setIsMenuOpen(false)} 
                    activeView={activeView} 
                    setActiveView={(view) => { setActiveView(view); setCurrentNotebookFolder(null); }} 
                />
                
                <EditModal 
                    isOpen={isEditModalOpen} 
                    item={editingItem} 
                    onClose={() => setIsEditModalOpen(false)} 
                    onSave={handleUpdateItem} 
                    folders={folders}
                />

                <AddModal 
                    isOpen={isAddModalOpen}
                    onClose={() => setIsAddModalOpen(false)}
                    onAdd={handleAddItem}
                    {...getAddModalProps()}
                />

                <FolderModal 
                    isOpen={folderModalConfig.isOpen}
                    title={folderModalConfig.mode === 'create' ? "Êñ∞Ë¶è„Éï„Ç©„É´„ÉÄ" : "„Éï„Ç©„É´„ÉÄÂêç„ÇíÂ§âÊõ¥"}
                    initialValue={folderModalConfig.initialValue}
                    onClose={() => setFolderModalConfig({ ...folderModalConfig, isOpen: false })}
                    onSave={handleFolderModalSave}
                />

                <ConfirmModal 
                    isOpen={deleteConfig.isOpen}
                    onClose={() => setDeleteConfig({ isOpen: false, type: null, id: null, contextId: null })}
                    onConfirm={performDelete}
                    message={getDeleteMessage()}
                />

                <SelectionMenu 
                    isOpen={isSelectionMenuOpen}
                    onClose={() => setIsSelectionMenuOpen(false)}
                    options={getMenuOptions()}
                    title={activeView === 'notebook' ? "„É°„É¢„ÇíËøΩÂä†" : "‰ªäÊúà„ÅÆÈ†ÖÁõÆ„ÇíËøΩÂä†"}
                />

                {/* FAB - Show on relevant views */}
                <FloatingActionButton 
                    visible={['year', 'month', 'tasks', 'notebook'].includes(activeView)} 
                    onClick={handleFabClick} 
                />

                <Header 
                    onOpenMenu={() => setIsMenuOpen(true)}
                    {...getHeaderProps()}
                />
                
                <main className="max-w-md mx-auto pt-2">
                    {activeView === 'year' && (
                    <YearView 
                        goals={yearlyGoals[fiscalYear] || []} 
                        fiscalYear={fiscalYear}
                        monthlyData={monthlyData}
                        onToggle={toggleComplete}
                        onDelete={handleDeleteRequest}
                        onEdit={openEditModal}
                        onDeleteFiscalYear={handleDeleteFiscalYearRequest}
                    />
                    )}
                    {activeView === 'month' && (
                    <MonthView 
                        data={monthlyData[currentKey] || {}} 
                        onToggle={toggleComplete}
                        onDelete={handleDeleteRequest}
                        onEdit={openEditModal}
                    />
                    )}
                    {activeView === 'tasks' && (
                    <TasksView 
                        tasks={monthlyData[currentKey]?.tasks || []} 
                        onToggle={toggleComplete}
                        onDelete={handleDeleteRequest}
                        onEdit={openEditModal}
                        showCompleted={showCompletedTasks}
                        onToggleShowCompleted={() => setShowCompletedTasks(!showCompletedTasks)}
                    />
                    )}
                    {activeView === 'notebook' && (
                    <NotebookView 
                        entries={notebookEntries}
                        folders={folders}
                        onDelete={handleDeleteRequest}
                        onEdit={openEditModal}
                        onFolderCreate={openCreateFolderModal} // Use modal opener
                        onFolderDelete={handleDeleteFolderRequest}
                        onFolderRename={openRenameFolderModal} // Use modal opener
                        currentFolder={currentNotebookFolder}
                        setCurrentFolder={setCurrentNotebookFolder}
                    />
                    )}
                </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
